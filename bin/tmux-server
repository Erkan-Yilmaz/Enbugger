#!perl

=head1 NAME

tmux-server - Internet server for tmux

=head1 SYNOPSIS

  tmux-server [options]

      --help
      --name <socket name>
      --port <port>      Listens on <port> [TCP service] and accepts a
                         TCP/IP connection. The IP version is 4 or
                         environment variable
                         SOCAT_DEFAULT_LISTEN_IP.

                         Default is 53505.
      --bind <sockname>  Binds the socket to the given socket address
                         using the bind() system call.

                         [hostname|hostaddress][:(service|port)]

                         Default is (*).
      --daemonize        (Default)
      --no-daemonize

=head1 DESCRIPTION

TODO

=cut

use strict;
use warnings;
use Getopt::Long ();
use Pod::Usage ();
use FindBin ();

Getopt::Long::GetOptions(
    help         => sub { Pod::Usage::pod2usage() },
    debug        => 
    name         => \ my $socket_name,
    bind         => \ my $bind_address,
    port         => \ my $tcp_port,
    'daemonize!' => \ my $daemonize,
)
  or Pod::Usage::pod2usage();
$daemonize //= 1;
$tcp_port  //= 53505;

if ( $daemonize ) {
  close *STDIN;
  close *STDOUT;
  close *STDERR;

  fork && exit;
  fork && exit;
  umask 0;
  chdir '/';
}

my $listen_spec = "TCP-LISTEN:${tcp_port},fork,reuseaddr";
if ( $bind_address ) {
  $listen_spec .= ",bind=$bind_address";
}
my $backend_spec = "EXEC:$FindBin::Bin/tmux-server-backend";
if ( $socket_name ) {
  $backend_spec .= " $socket_name";
}
$backend_spec .= ",setsid,nofork";
exec
  'socat', $listen_spec, $backend_spec;
