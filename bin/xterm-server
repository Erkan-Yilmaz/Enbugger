#!perl -w

=head1 NAME

xterm-server - Internet server for xterm

=head1 SYNOPSIS

  screen-server [options]

      --help
      --debug
      --port <port>      Listens on <port> [TCP service] and accepts a
                         TCP/IP connection. The IP version is 4 or
                         environment variable
                         SOCAT_DEFAULT_LISTEN_IP.

                         Default is 53505.
      --bind <sockname>  Binds the socket to the given socket address
                         using the bind() system call.

                         [hostname|hostaddress][:(service|port)]

                         Default is (*).
      --daemonize        (Default)
      --no-daemonize

=head1 DESCRIPTION

TODO

=cut

use strict;
use 5.005;
use Getopt::Long ();
use FindBin ();

Getopt::Long::GetOptions(
    help         => \ &pod2usage,
    debug        => \ my $debug,
    name         => \ my $screen_name,
    bind         => \ my $bind_address,
    port         => \ my $tcp_port,
    'daemonize!' => \ my $daemonize,
)
    or pod2usage();
$daemonize = 1     if ! defined $daemonize;
$tcp_port  = 53505 if ! defined $tcp_port;

if ( $daemonize ) {
    close *STDIN;
    close *STDOUT;
    close *STDERR;

    fork && exit;
    fork && exit;
    umask 0;
    chdir '/';
}

my $listen_spec = "TCP-LISTEN:${tcp_port},fork,reuseaddr";
if ( $bind_address ) {
    $listen_spec .= ",bind=$bind_address";
}
my $backend_spec = "EXEC:$FindBin::Bin/xterm-server-backend,setsid,nofork";
my @cmd = ( 'socat', $listen_spec, $backend_spec );
if ( $debug ) {
    print STDERR "exec( @cmd )\n";
}
exec @cmd;

sub pod2usage {
    require Pod::Usage;
    goto &Pod::Usage::pod2usage;
}
