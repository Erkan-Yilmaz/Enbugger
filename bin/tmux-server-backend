#!perl

=head1 NAME

tmux-server-backend - TODO

=head1 SYNOPSIS

tmux-server-backend [options]

    --help
    --name <socket name>

=head1 DESCRIPTION

TODO

=cut


use strict;
use warnings;
use 5.010_000;
use autodie ':all';
use File::Temp ();
use Getopt::Long ();
use Pod::Usage ();

Getopt::Long::GetOptions(
    help => sub { Pod::Usage::pod2usage() },
    name => \ my $socket_name,
)
  or Pod::Usage::pod2usage();

{
    # Enable $SIG{CHLD}='IGNORE' only for a tight scope because
    # autodie.pm will notice the ECHILD from a waitpid() on the
    # system() below. :-(
    local $SIG{CHLD} = 'IGNORE';
    fork && exit;
    fork && exit;
}
umask 0;
chdir '/';

my ( $log_fh, $log_fn ) = File::Temp::tempfile();

system 'tmux', 'new-window', "tty > $log_fn; sleep 10000000";
sleep 1;

my $tty = <$log_fh>;
chomp $tty;

system 'socat', '-', "FILE:$tty";

no autodie;
open my $tty_fh, '>', $tty;
syswrite $tty_fh, "Socket closed\n";
close $tty_fh;

kill -2,  0;
kill -15, 0;
kill -9,  0;
