#!perl -w

=head1 NAME

tmux-server-backend - TODO

=head1 SYNOPSIS

tmux-server-backend [options]

    --help
    --name <socket name>

=head1 DESCRIPTION

TODO

=cut


use strict;
use 5.010_000;
use autodie ':all';
use File::Temp ();
use Getopt::Long ();

Getopt::Long::GetOptions(
    help  => \&pod2usage,
    debug => \ my $debug,
    name  => \ my $socket_name,
    'daemonize!' => \ my $daemonize,
)
    or pod2usage();

if ( $daemonize ) {
    fork && exit;
    fork && exit;
    umask 0;
    chdir '/';
}

my ( $log_fh, $log_fn ) = File::Temp::tempfile();

system 'tmux', 'new-window', "tty > $log_fn; sleep 10000000";
sleep 1;

my $tty = <$log_fh>;
chomp $tty;

system 'socat', '-', "FILE:$tty";

no autodie;
open my $tty_fh, '>', $tty;
syswrite $tty_fh, "Socket closed\n";
close $tty_fh;

kill -2,  0;
kill -15, 0;
kill -9,  0;


sub pod2usage {
    require Pod::Usage;
    goto &Pod::Usage::pod2usage;
}
